(window.webpackJsonp=window.webpackJsonp||[]).push([[32],{390:function(e,t,a){"use strict";a.r(t);var s=a(44),n=Object(s.a)({},(function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("h1",{attrs:{id:"ocserv"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ocserv"}},[e._v("#")]),e._v(" ocserv")]),e._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://gitlab.com/openconnect/recipes",target:"_blank",rel:"noopener noreferrer"}},[e._v("recipes"),a("OutboundLink")],1)]),e._v(" "),a("li",[a("a",{attrs:{href:"https://openconnect.github.io/openconnect-gui/",target:"_blank",rel:"noopener noreferrer"}},[e._v("openconnect-gui"),a("OutboundLink")],1)]),e._v(" "),a("li",[a("a",{attrs:{href:"https://download.escope.net/Cisco/asa/vpn/",target:"_blank",rel:"noopener noreferrer"}},[e._v("AnyConnect"),a("OutboundLink")],1)]),e._v(" "),a("li",[a("a",{attrs:{href:"https://www.vps000.org/",target:"_blank",rel:"noopener noreferrer"}},[e._v("威伯斯云"),a("OutboundLink")],1)]),e._v(" "),a("li",[a("a",{attrs:{href:"https://v2ex.com/t/665868",target:"_blank",rel:"noopener noreferrer"}},[e._v("配置不代理局域网"),a("OutboundLink")],1)]),e._v(" "),a("li",[a("a",{attrs:{href:"https://github.com/CNMan/ocserv-cn-no-route",target:"_blank",rel:"noopener noreferrer"}},[e._v("ocserv-cn-no-route"),a("OutboundLink")],1)]),e._v(" "),a("li",[a("a",{attrs:{href:"https://yuerblog.cc/2020/11/21/%e5%ae%b6%e5%ba%ad%e6%90%ad%e5%bb%baopenconnect-vpn/",target:"_blank",rel:"noopener noreferrer"}},[e._v("家庭搭建openconnect vpn"),a("OutboundLink")],1)]),e._v(" "),a("li",[a("a",{attrs:{href:"https://beijing.bb/splitting-network-traffic-based-on-destinations/",target:"_blank",rel:"noopener noreferrer"}},[e._v("野生思科分离隧道"),a("OutboundLink")],1)]),e._v(" "),a("li",[a("a",{attrs:{href:"https://www.ioiox.com/archives/90.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("OpenWRT 路由器 OpenConnect VPN 详细图文教程"),a("OutboundLink")],1)]),e._v(" "),a("li",[a("a",{attrs:{href:"https://www.petenetlive.com/KB/Article/0000546",target:"_blank",rel:"noopener noreferrer"}},[e._v("VPN establishment capability for a remote user"),a("OutboundLink")],1)]),e._v(" "),a("li",[a("a",{attrs:{href:"https://blog.expta.com/2020/04/how-to-enable-cisco-anyconnect-vpn.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("through Remote Desktop"),a("OutboundLink")],1)])]),e._v(" "),a("p",[a("strong",[e._v("安装")])]),e._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[e._v("apt")]),e._v(" update\n"),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("apt")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("install")]),e._v(" ocserv\n")])])]),a("p",[a("strong",[e._v("ssl证书")])]),e._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[e._v("mkdir")]),e._v(" /root/certificates\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("cd")]),e._v(" /root/certificates\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# ca")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("tee")]),e._v(" /root/certificates/ca.tmpl "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<<-")]),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('\'EOF\'\ncn = "HX CA"\norganization = "HX"\nserial = 1\nexpiration_days = 3650\nca\nsigning_key\ncert_signing_key\ncrl_signing_key\nEOF')]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# user")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("tee")]),e._v(" /root/certificates/user.tmpl "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<<-")]),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('\'EOF\'\ncn = "huxins"\nunit = "HX"\nexpiration_days = 3650\nsigning_key\ntls_www_client\nEOF')]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# server")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("tee")]),e._v(" /root/certificates/server.tmpl "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<<-")]),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('\'EOF\'\ncn = "a sever\'s name, usually matches hostname"\norganization = "your organization"\nserial = 2\nexpiration_days = 3650\nsigning_key\nencryption_key\ntls_www_server\ndns_name = "your organization\'s host name"\n#ip_address = "if no hostname uncomment and set the IP address here"\nEOF')]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# 生成CA证书")]),e._v("\ncerttool --generate-privkey --outfile ca-key.pem\ncerttool --generate-self-signed --hash SHA256 --load-privkey ca-key.pem --template ca.tmpl --outfile ca-cert.pem\ncerttool -i --infile ca-cert.pem\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# 生成 Diffie-Hellman 密钥")]),e._v("\ncerttool --generate-dh-params --outfile /etc/ocserv/ssl/dh.pem\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# CA签发VPN证书")]),e._v("\ncerttool --generate-privkey --outfile server-key.pem\ncerttool --generate-certificate --hash SHA256 --load-privkey server-key.pem --load-ca-certificate ca-cert.pem --load-ca-privkey ca-key.pem --template server.tmpl --outfile server-cert.pem\ncerttool -i --infile user-cert.pem\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# CA签发用户证书")]),e._v("\ncerttool --generate-privkey --outfile user-key.pem\ncerttool --generate-certificate --hash SHA256 --load-privkey user-key.pem --load-ca-certificate ca-cert.pem --load-ca-privkey ca-key.pem --template user.tmpl --outfile user-cert.pem\ncerttool -i --infile user-cert.pem\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# 证书链补全")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("cat")]),e._v(" /root/certificates/ca-cert.pem "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">>")]),e._v(" /root/certificates/user-cert.pem\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# 生成.p12证书文件")]),e._v("\nopenssl pkcs12 -export -inkey user-key.pem -in user-cert.pem -name "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"huxins"')]),e._v(" -certfile ca-cert.pem -caname "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"HX CA"')]),e._v(" -out huxins.AnyConnect.p12 -passout pass:12345678\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# 把VPN证书拷到ocserv配置目录下")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("cp")]),e._v(" server-cert.pem server-key.pem /etc/ocserv/\n")])])]),a("p",[a("strong",[e._v("配置")])]),e._v(" "),a("p",[e._v("/etc/ocserv/ocserv.conf")]),e._v(" "),a("div",{staticClass:"language-ini extra-class"},[a("pre",{pre:!0,attrs:{class:"language-ini"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key attr-name"}},[e._v("auth")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("=")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[e._v('"'),a("span",{pre:!0,attrs:{class:"token inner-value"}},[e._v("certificate")]),e._v('"')]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[e._v("ca-cert")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("=")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[e._v("/etc/ocserv/ca-cert.pem")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[e._v("cert-user-oid")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("=")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[e._v("2.5.4.3")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[e._v("server-cert")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("=")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[e._v("/etc/ocserv/server-cert.pem")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[e._v("server-key")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("=")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[e._v("/etc/ocserv/server-key.pem")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[e._v("tcp-port")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("=")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[e._v("443")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[e._v("udp-port")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("=")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[e._v("443")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[e._v("ipv4-network")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("=")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[e._v("192.168.8.0")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[e._v("ipv4-netmask")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("=")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[e._v("255.255.255.0")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[e._v("dns")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("=")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[e._v("8.8.8.8")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[e._v("no-route")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("=")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[e._v("172.26.201.0/255.255.255.0")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[e._v("route")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("=")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[e._v("192.168.11.0/255.255.255.0")]),e._v("\n")])])]),a("p",[a("strong",[e._v("创建VPN用户")])]),e._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("ocpasswd -c /etc/ocserv/ocpasswd myvpnuser\n")])])]),a("p",[a("strong",[e._v("VPN拨号")])]),e._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("echo")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("$(")]),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("sudo")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("cat")]),e._v(" /etc/openconnect/password"),a("span",{pre:!0,attrs:{class:"token variable"}},[e._v(")")])]),e._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("sudo")]),e._v(" openconnect -b https://YourORGVPNURL -u YourOrgVPNUsername --passwd-on-stdin\n")])])]),a("p",[a("strong",[e._v("VPN服务")])]),e._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("ocserv -c /etc/ocserv/ocserv.conf -f -d "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("1")]),e._v("\n")])])]),a("p",[a("strong",[e._v("防火墙")])]),e._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("iptables -t nat -I POSTROUTING -s "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("192.168")]),e._v(".100.0/24 -j MASQUERADE\niptables -I FORWARD -i vpns+ -s "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("192.168")]),e._v(".100.0/24 -j ACCEPT\niptables -I INPUT -i vpns+ -s "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("192.168")]),e._v(".100.0/24 -j ACCEPT\n\nfirewall-cmd --permanent --zone"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("public --add-port"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("443")]),e._v("/tcp\nfirewall-cmd --permanent --zone"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("public --add-port"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("443")]),e._v("/udp\nfirewall-cmd --permanent --add-masquerade\nfirewall-cmd --permanent --direct --passthrough ipv4 -t nat -A POSTROUTING -o ens34 -j MASQUERADE\nfirewall-cmd --reload\n")])])])])}),[],!1,null,null,null);t.default=n.exports}}]);